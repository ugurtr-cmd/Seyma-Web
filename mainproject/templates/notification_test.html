{% extends "layout_admin.html" %}
{% load static %}

{% block title %}Bildirim Test - Åeyma{% endblock %}

{% block css_file %}
<style>
    .test-container {
        max-width: 800px;
        margin: 2rem auto;
        padding: 2rem;
    }
    
    .test-card {
        background: white;
        border-radius: 15px;
        padding: 2rem;
        margin-bottom: 2rem;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    }
    
    .test-button {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        margin: 10px;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .test-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
    }
    
    .result {
        margin-top: 1rem;
        padding: 1rem;
        border-radius: 8px;
        background: #f8f9fa;
        border-left: 4px solid #28a745;
    }
    
    .error {
        border-left-color: #dc3545;
        background: #fff5f5;
    }
</style>
{% endblock %}

{% block content %}
<div class="test-container">
    <div class="test-card">
        <h2>ğŸ”” PWA Bildirim Test Sistemi</h2>
        <p>Bu sayfa PWA bildirimlerini test etmek iÃ§in oluÅŸturulmuÅŸtur.</p>
        
        <div class="row">
            <div class="col-md-6">
                <h4>Bildirim Ä°zni</h4>
                <button class="test-button" onclick="requestPermission()">
                    ğŸ“± Bildirim Ä°zni Ä°ste
                </button>
                <div id="permission-result"></div>
            </div>
            
            <div class="col-md-6">
                <h4>Test Bildirimleri</h4>
                <button class="test-button" onclick="testBasicNotification()">
                    ğŸ§ª Test Bildirimi
                </button>
                <div id="test-result"></div>
            </div>
        </div>
        
        <hr>
        
        <div class="row">
            <div class="col-md-6">
                <h4>GÃ¼nlÃ¼k Mesaj Bildirimi</h4>
                <button class="test-button" onclick="testDailyMessage()">
                    ğŸ’ GÃ¼nlÃ¼k Mesaj GÃ¶nder
                </button>
                <div id="daily-result"></div>
            </div>
            
            <div class="col-md-6">
                <h4>HaftalÄ±k Rapor</h4>
                <button class="test-button" onclick="testWeeklyReport()">
                    ğŸ“Š HaftalÄ±k Rapor GÃ¶nder
                </button>
                <div id="weekly-result"></div>
            </div>
        </div>
        
        <hr>
        
        <div class="mt-4">
            <h4>Bildirim Durumu</h4>
            <div id="notification-status">
                <p>Bildirim izni: <span id="permission-status">Kontrol ediliyor...</span></p>
                <p>Service Worker: <span id="sw-status">Kontrol ediliyor...</span></p>
                <p>Push desteÄŸi: <span id="push-status">Kontrol ediliyor...</span></p>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    checkNotificationStatus();
});

function checkNotificationStatus() {
    // Bildirim izni kontrolÃ¼
    if ('Notification' in window) {
        document.getElementById('permission-status').textContent = Notification.permission;
    } else {
        document.getElementById('permission-status').textContent = 'Desteklenmiyor';
    }
    
    // Service Worker kontrolÃ¼
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.ready.then(function() {
            document.getElementById('sw-status').textContent = 'Aktif';
        }).catch(function() {
            document.getElementById('sw-status').textContent = 'Hata';
        });
    } else {
        document.getElementById('sw-status').textContent = 'Desteklenmiyor';
    }
    
    // Push desteÄŸi kontrolÃ¼
    if ('PushManager' in window) {
        document.getElementById('push-status').textContent = 'Destekleniyor';
    } else {
        document.getElementById('push-status').textContent = 'Desteklenmiyor';
    }
}

function requestPermission() {
    if ('Notification' in window) {
        Notification.requestPermission().then(function(permission) {
            const result = document.getElementById('permission-result');
            if (permission === 'granted') {
                result.innerHTML = '<div class="result">âœ… Bildirim izni verildi!</div>';
                checkNotificationStatus();
            } else {
                result.innerHTML = '<div class="result error">âŒ Bildirim izni reddedildi</div>';
            }
        });
    } else {
        document.getElementById('permission-result').innerHTML = 
            '<div class="result error">âŒ Bu tarayÄ±cÄ± bildirimleri desteklemiyor</div>';
    }
}

function testBasicNotification() {
    fetch('/api/test-bildirim/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        const result = document.getElementById('test-result');
        if (data.success) {
            result.innerHTML = `<div class="result">âœ… Test bildirimi gÃ¶nderildi! BaÅŸarÄ±lÄ±: ${data.sonuc.basarili}, BaÅŸarÄ±sÄ±z: ${data.sonuc.basarisiz}</div>`;
        } else {
            result.innerHTML = `<div class="result error">âŒ Hata: ${data.error}</div>`;
        }
    })
    .catch(error => {
        document.getElementById('test-result').innerHTML = 
            `<div class="result error">âŒ Ä°stek hatasÄ±: ${error}</div>`;
    });
}

function testDailyMessage() {
    fetch('/api/daily-message-notification/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        const result = document.getElementById('daily-result');
        if (data.success) {
            result.innerHTML = `<div class="result">âœ… GÃ¼nlÃ¼k mesaj bildirimi gÃ¶nderildi! BaÅŸarÄ±lÄ±: ${data.sonuc.basarili}, BaÅŸarÄ±sÄ±z: ${data.sonuc.basarisiz}</div>`;
        } else {
            result.innerHTML = `<div class="result error">âŒ Hata: ${data.error}</div>`;
        }
    })
    .catch(error => {
        document.getElementById('daily-result').innerHTML = 
            `<div class="result error">âŒ Ä°stek hatasÄ±: ${error}</div>`;
    });
}

function testWeeklyReport() {
    fetch('/api/weekly-report-notification/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        const result = document.getElementById('weekly-result');
        if (data.success) {
            result.innerHTML = `<div class="result">âœ… HaftalÄ±k rapor bildirimi gÃ¶nderildi! BaÅŸarÄ±lÄ±: ${data.sonuc.basarili}, BaÅŸarÄ±sÄ±z: ${data.sonuc.basarisiz}</div>`;
        } else {
            result.innerHTML = `<div class="result error">âŒ Hata: ${data.error}</div>`;
        }
    })
    .catch(error => {
        document.getElementById('weekly-result').innerHTML = 
            `<div class="result error">âŒ Ä°stek hatasÄ±: ${error}</div>`;
    });
}
</script>

{% csrf_token %}
{% endblock %}